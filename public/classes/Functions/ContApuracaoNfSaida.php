<?php
require_once __DIR__ . '/../DBConnect.php';

class ContabilApuracaoNfSaida
{
  private $senior;

  public function __construct()
  {
    $this->senior = DatabaseConnection::getConnection('senior');

    $this->senior->setAttribute(PDO::ATTR_EMULATE_PREPARES, true);
  }
  /**
   * Gera arrays [primeiroDia, ultimoDia] a partir de 'MM/YYYY'
   */
  public static function obterPrimeiroUltimoDia(string $mesAno): array
  {
    $data = \DateTime::createFromFormat('m/Y', $mesAno);
    if (! $data) {
      throw new \InvalidArgumentException("Mês/Ano inválido: {$mesAno}");
    }
    $primeiro = $data->format('Ym01');               // YYYY-mm-01
    $ultimo    = $data->modify('last day of this month')->format('Ymd');
    // echo "<pre>";
    // var_dump($primeiro, $ultimo);
    // die();
    return [$primeiro, $ultimo];
  }

  /**
   * Método público que dispara todas as consultas e retorna um array com cada resultado
   */
  public function gerarRelatorio(string $mesAno): array
  {
    list($primeiroDia, $ultimoDia) = self::obterPrimeiroUltimoDia($mesAno);

    return [
      'notasSaida'   => $this->ConsultaNotasSaida($primeiroDia, $ultimoDia),
      'loteContabil' => $this->ConsultaLoteContabil($primeiroDia, $ultimoDia),
    ];
  }

  private function ConsultaNotasSaida(string $primeiroDia, string $ultimoDia): array
  {
    $sql = "SELECT E140NFV.CODFIL, E140NFV.CODSNF, E140NFV.NUMNFV, E140NFV.TNSPRO, E140NFV.NOPPRO, E140NFV.TNSSER, E140NFV.NOPSER, E140NFV.DATEMI, E140NFV.CODCLI, 
      E140NFV.CODREP, E140NFV.CODCPG, E140NFV.DATSAI, E140NFV.HORSAI, E140NFV.CODTRA, E140NFV.PLAVEI, E140NFV.VLRFRE, E140NFV.CIFFOB, E140NFV.PESBRU, E140NFV.PESLIQ, 
      E140NFV.PERDS1, E140NFV.PERDS2, E140NFV.VLRBPR, E140NFV.VLRDPR, E140NFV.VLRBSE, E140NFV.VLRDSE, E140NFV.VLRLIQ, E140NFV.QTDITP, E140NFV.QTDITS, E140NFV.QTDEMI, 
      E140NFV.SITNFV, E140NFV.TIPNFS, E140NFV.NFVBLO, E140NFV.NUMLOT, E140NFV.CODRED, E140NFV.CODEMB, E140NFV.NUMEMB, E140NFV.QTDEMB, E140NFV.OBSNFV, E140NFV.CODMS1, 
      E140NFV.CODMS2, E140NFV.CODMS3, E140NFV.CODMS4, E085CLI.SIGUFS, E085CLI.CIDCLI, E085CLI.CODRAM, E090HRP.CODRVE, E085CLI.CODGRE, E140NFV.INTIMP, E140NFV.CODEDC, 
      E140NFV.CODRAI, E140NFV.VLRFIN, E140NFV.VLRLOU, E140NFV.VLRDAR, E140NFV.VLRSEG, E140NFV.VLREMB, E140NFV.VLROUD, E140NFV.VLRFRD, E140NFV.VLRBIP, E140NFV.VLRBIN, 
      E140NFV.VLRINS, E140NFV.VLRBIC, E140NFV.VLRBSI, E140NFV.VLRLPR, E140NFV.VLRIPI, E140NFV.VLRICM, E140NFV.VLRSIC, E140NFV.VLRBIS, E140NFV.VLRBIR, E140NFV.VLRLSE, 
      E140NFV.VLRISS, E140NFV.VLRIRF, E140NFV.VLRBCO, E140NFV.VLRCOM, E140NFV.VLRDS1, E140NFV.VLRDS2, E140NFV.VLRDS3, E140NFV.VLRDS4, E140NFV.VLRBSC, E140NFV.VLRSTC, 
      E140NFV.VLRBSP, E140NFV.VLRDS5, E140NFV.PERDS3, E140NFV.PERDS4, E140NFV.PERDS5, E140NFV.VLRSTP, E140NFV.VLRDZF, E140NFV.USUGER, E140NFV.DATGER, E140NFV.HORGER, 
      E140NFV.VLRBII, E140NFV.VLRIIM, E140NFV.VLRRIS, E140NFV.NUMCFI, E140NFV.VLRBPT, E140NFV.VLRPIT, E140NFV.VLRBCT, E140NFV.VLRCRT, E140NFV.VLRBCL, E140NFV.VLRCSL, 
      E028CPG.DESCPG, E140IDE.SITDOE, E140IDE.CHVDOE, E085CLI.TIPEMC, E140NFV.VLRBPF, E140NFV.VLRPIF, E140NFV.VLRBCF, E140NFV.VLRCFF, E140NFV.DATVIS, E140NFV.HORVIS, 
      E140NFV.DATCMC, E140NFV.HORCMC, E140NFV.SEQENT, E140NFV.SEQCOB, E140NFV.VOLNFV, E140NFV.NUMROM, E140NFV.VLRBSF, E140NFV.VLRSIF, E140NFV.SNFNCF, E140NFV.NUMNCF, 
      E140NFV.SOMFRE, E140NFV.VLRBOR, E140NFV.VLROUR, E140NFV.TOTCID, E140IDE.NUMDFS, E140NFV.NUMPIN, E140IDE.NUMPRT, E085CLI.NOMCLI, E085CLI.APECLI, E140NFV.DATAGE, 
      E140NFV.QTDBPF, E140NFV.QTDBLO, E140NFV.QTDDUP, E140NFV.QTDBCF, E140NFV.QTDBIP, E140IDE.SITDEA, E140IDE.CODVER, E140IDE.USUEMI, E140IDE.NUMPRC, E140NFV.HOREMI, 
      E140NFV.CODFCR, E140NFV.CODMOE, E140NFV.COTMOE, E140NFV.DATFCR, E140NFV.DATMOE, E140IDE.DATCAN, E140IDE.HORCAN, E140IDE.USUCAN, E140IDE.NUMPRI, E140IDE.DATINU, 
      E140IDE.HORINU, E140IDE.USUINU, E140NFV.CODEQU, E140NFV.DATIMP, E140NFV.HORIMP, E140NFV.VLRSUB, E140TNF.VLRISN, E140TNF.VLRIBS, E140TNF.VLRIDV, E140NFV.CODEMP, 
      E140IDE.TIPCTG, E140IDE.CHVCTG, E140TNF.VLRSEN, E140TNF.VLRBSN, E140NFV.VLRFUN, E140NFV.VLRBFU, E140TNF.VLRIDF, E140TNF.BASIDF, E140TNF.NUMPDV, E140TNF.BASIEF,
      E140TNF.VLRIEF, E140TNF.PEDCLI, E140TNF.CODSAF, E140NFV.NUMINT, E020SNF.DISAUT, E172IMA.CODSMA, E172IMA.NUMMAN, E140TNF.VLRIOR, E140TNF.VLRBDE, E140TNF.VLRIDE, 
      E140TNF.BASFCP, E140TNF.VLRFCP, E140TNF.BSTFCP, E140TNF.VSTFCP, E140TNF.BREFCP, E140TNF.VREFCP, E140TNF.ICMBFC, E140TNF.ICMVFC, E140TNF.VLRBGI, E140TNF.VLRGIL, 
      E140NFV.VLRICD, E140TNF.INDPRE, E140TNF.INDITM, E140TNF.CODITM, E140TNF.CGCITM, E140TNF.CADITM, E140TNF.VDIFCS, E140TNF.EFIFCS, E140TNF.VICSDT, 
      E140TNF.CTREXT AS TNFCTREXT, E140TNF.QTMBIC, E140TNF.VMOICM, E140TNF.QTMBIR, E140TNF.VMOICR, E140TNF.QTMBIF, E140TNF.VMOICF, E140TNF.QTMBID, E140TNF.VMOICD, 
      (SELECT TOP(1) E120PED.CTREXT FROM E120PED INNER JOIN E140IPV ON E140IPV.CODEMP = E120PED.CODEMP AND E140IPV.FILPED = E120PED.CODFIL AND E140IPV.NUMPED = E120PED.NUMPED  
        WHERE E140IPV.CODEMP = E140NFV.CODEMP AND E140IPV.CODFIL = E140NFV.CODFIL AND E140IPV.CODSNF = E140NFV.CODSNF AND E140IPV.NUMNFV = E140NFV.NUMNFV ) AS PEDCTREXT,
      'N' AS TEMCCE ,'N' AS TEMPSI 
      FROM E085CLI, E090HRP, E028CPG, E020SNF, E140NFV 
        LEFT OUTER JOIN E140IDE ON E140IDE.CODEMP = E140NFV.CODEMP AND E140IDE.CODFIL = E140NFV.CODFIL AND E140IDE.CODSNF = E140NFV.CODSNF AND E140IDE.NUMNFV = E140NFV.NUMNFV 
        LEFT OUTER JOIN E140TNF ON E140TNF.CODEMP = E140NFV.CODEMP AND E140TNF.CODFIL = E140NFV.CODFIL AND  E140TNF.CODSNF = E140NFV.CODSNF AND  E140TNF.NUMNFV = E140NFV.NUMNFV
        LEFT OUTER JOIN E172IMA ON  E172IMA.CODEMP = E140NFV.CODEMP AND  E172IMA.FILNFV = E140NFV.CODFIL AND  E172IMA.CODSNF = E140NFV.CODSNF AND  E172IMA.NUMNFV = E140NFV.NUMNFV 
      WHERE E140NFV.CODEMP = 1 AND E020SNF.CODEMP = E140NFV.CODEMP  AND E020SNF.CODFIL = E140NFV.CODFIL  AND E020SNF.CODSNF = E140NFV.CODSNF  AND 0=0 
        AND E140NFV.CODCLI = E085CLI.CODCLI AND E140NFV.CODREP = E090HRP.CODREP AND E090HRP.CODEMP = 1 AND E028CPG.CODEMP = E140NFV.CODEMP  AND E028CPG.CODCPG = E140NFV.CODCPG 
        AND E140NFV.DATEMI >= :primeiro AND E140NFV.DATEMI <= :ultimo AND E140NFV.TNSPRO NOT IN ('1918') 
        AND NOT EXISTS (SELECT 1 FROM E143NFV WHERE E143NFV.CODEMP = E140NFV.CODEMP AND E143NFV.FILNFV = E140NFV.CODFIL AND E143NFV.CODSNF = E140NFV.CODSNF AND E143NFV.NUMNFV = E140NFV.NUMNFV) 
      UNION ALL 
      SELECT E140NFV.CODFIL, E140NFV.CODSNF, E140NFV.NUMNFV, E140NFV.TNSPRO, E140NFV.NOPPRO, E140NFV.TNSSER, E140NFV.NOPSER, E140NFV.DATEMI, E140NFV.CODCLI, E140NFV.CODREP, 
        E140NFV.CODCPG, E140NFV.DATSAI, E140NFV.HORSAI, E140NFV.CODTRA, E140NFV.PLAVEI, E140NFV.VLRFRE, E140NFV.CIFFOB, E140NFV.PESBRU, E140NFV.PESLIQ, E140NFV.PERDS1, 
        E140NFV.PERDS2, E140NFV.VLRBPR, E140NFV.VLRDPR, E140NFV.VLRBSE, E140NFV.VLRDSE, E140NFV.VLRLIQ, E140NFV.QTDITP, E140NFV.QTDITS, E140NFV.QTDEMI, E140NFV.SITNFV, 
        E140NFV.TIPNFS, E140NFV.NFVBLO, E140NFV.NUMLOT, E140NFV.CODRED, E140NFV.CODEMB, E140NFV.NUMEMB, E140NFV.QTDEMB, E140NFV.OBSNFV, E140NFV.CODMS1, E140NFV.CODMS2, 
        E140NFV.CODMS3, E140NFV.CODMS4, E085CLI.SIGUFS, E085CLI.CIDCLI, E085CLI.CODRAM, E090HRP.CODRVE, E085CLI.CODGRE, E140NFV.INTIMP, E140NFV.CODEDC, E140NFV.CODRAI, 
        E140NFV.VLRFIN, E140NFV.VLRLOU, E140NFV.VLRDAR, E140NFV.VLRSEG, E140NFV.VLREMB, E140NFV.VLROUD, E140NFV.VLRFRD, E140NFV.VLRBIP, E140NFV.VLRBIN, E140NFV.VLRINS, 
        E140NFV.VLRBIC, E140NFV.VLRBSI, E140NFV.VLRLPR, E140NFV.VLRIPI, E140NFV.VLRICM, E140NFV.VLRSIC, E140NFV.VLRBIS, E140NFV.VLRBIR, E140NFV.VLRLSE, E140NFV.VLRISS, 
        E140NFV.VLRIRF, E140NFV.VLRBCO, E140NFV.VLRCOM, E140NFV.VLRDS1, E140NFV.VLRDS2, E140NFV.VLRDS3, E140NFV.VLRDS4, E140NFV.VLRBSC, E140NFV.VLRSTC, E140NFV.VLRBSP, 
        E140NFV.VLRDS5, E140NFV.PERDS3, E140NFV.PERDS4, E140NFV.PERDS5, E140NFV.VLRSTP, E140NFV.VLRDZF, E140NFV.USUGER, E140NFV.DATGER, E140NFV.HORGER, E140NFV.VLRBII, 
        E140NFV.VLRIIM, E140NFV.VLRRIS, E140NFV.NUMCFI, E140NFV.VLRBPT, E140NFV.VLRPIT, E140NFV.VLRBCT, E140NFV.VLRCRT, E140NFV.VLRBCL, E140NFV.VLRCSL, E028CPG.DESCPG, 
        E140IDE.SITDOE, E140IDE.CHVDOE, E085CLI.TIPEMC, E140NFV.VLRBPF, E140NFV.VLRPIF, E140NFV.VLRBCF, E140NFV.VLRCFF, E140NFV.DATVIS, E140NFV.HORVIS, E140NFV.DATCMC, 
        E140NFV.HORCMC, E140NFV.SEQENT, E140NFV.SEQCOB, E140NFV.VOLNFV, CONVERT(VARCHAR(10), E143NFV.NUMROM), E140NFV.VLRBSF, E140NFV.VLRSIF, E140NFV.SNFNCF, 
        E140NFV.NUMNCF, E140NFV.SOMFRE, E140NFV.VLRBOR, E140NFV.VLROUR, E140NFV.TOTCID, E140IDE.NUMDFS, E140NFV.NUMPIN, E140IDE.NUMPRT, E085CLI.NOMCLI, E085CLI.APECLI, 
        E140NFV.DATAGE, E140NFV.QTDBPF, E140NFV.QTDBLO, E140NFV.QTDDUP, E140NFV.QTDBCF, E140NFV.QTDBIP, E140IDE.SITDEA, E140IDE.CODVER, E140IDE.USUEMI, E140IDE.NUMPRC, 
        E140NFV.HOREMI, E140NFV.CODFCR, E140NFV.CODMOE, E140NFV.COTMOE, E140NFV.DATFCR, E140NFV.DATMOE, E140IDE.DATCAN, E140IDE.HORCAN, E140IDE.USUCAN, E140IDE.NUMPRI, 
        E140IDE.DATINU, E140IDE.HORINU, E140IDE.USUINU, E140NFV.CODEQU, E140NFV.DATIMP, E140NFV.HORIMP, E140NFV.VLRSUB, E140TNF.VLRISN, E140TNF.VLRIBS, E140TNF.VLRIDV, 
        E140NFV.CODEMP, E140IDE.TIPCTG, E140IDE.CHVCTG, E140TNF.VLRSEN, E140TNF.VLRBSN, E140NFV.VLRFUN, E140NFV.VLRBFU, E140TNF.VLRIDF, E140TNF.BASIDF, E140TNF.NUMPDV, 
        E140TNF.BASIEF, E140TNF.VLRIEF, E140TNF.PEDCLI, E140TNF.CODSAF, E140NFV.NUMINT, E020SNF.DISAUT, E172IMA.CODSMA, E172IMA.NUMMAN, E140TNF.VLRIOR, E140TNF.VLRBDE,
        E140TNF.VLRIDE, E140TNF.BASFCP, E140TNF.VLRFCP, E140TNF.BSTFCP, E140TNF.VSTFCP, E140TNF.BREFCP, E140TNF.VREFCP, E140TNF.ICMBFC, E140TNF.ICMVFC, E140TNF.VLRBGI, 
        E140TNF.VLRGIL, E140NFV.VLRICD, E140TNF.INDPRE, E140TNF.INDITM, E140TNF.CODITM, E140TNF.CGCITM, E140TNF.CADITM, E140TNF.VDIFCS, E140TNF.EFIFCS, E140TNF.VICSDT, 
        E140TNF.CTREXT AS TNFCTREXT, E140TNF.QTMBIC, E140TNF.VMOICM, E140TNF.QTMBIR, E140TNF.VMOICR, E140TNF.QTMBIF, E140TNF.VMOICF, E140TNF.QTMBID, E140TNF.VMOICD, 
        (SELECT  TOP(1)  E120PED.CTREXT FROM E120PED INNER JOIN E140IPV ON E140IPV.CODEMP = E120PED.CODEMP AND E140IPV.FILPED = E120PED.CODFIL AND E140IPV.NUMPED = E120PED.NUMPED 
          WHERE E140IPV.CODEMP = E140NFV.CODEMP AND E140IPV.CODFIL = E140NFV.CODFIL AND E140IPV.CODSNF = E140NFV.CODSNF AND E140IPV.NUMNFV = E140NFV.NUMNFV ) AS PEDCTREXT ,
        'N' AS TEMCCE ,'N' AS TEMPSI 
      FROM E085CLI, E090HRP, E028CPG, E143NFV, E020SNF, E140NFV 
        LEFT OUTER JOIN E140IDE ON  E140IDE.CODEMP = E140NFV.CODEMP AND  E140IDE.CODFIL = E140NFV.CODFIL AND  E140IDE.CODSNF = E140NFV.CODSNF AND  E140IDE.NUMNFV = E140NFV.NUMNFV 
        LEFT OUTER JOIN E140TNF ON  E140TNF.CODEMP = E140NFV.CODEMP AND  E140TNF.CODFIL = E140NFV.CODFIL AND  E140TNF.CODSNF = E140NFV.CODSNF AND  E140TNF.NUMNFV = E140NFV.NUMNFV 
        LEFT OUTER JOIN E172IMA ON  E172IMA.CODEMP = E140NFV.CODEMP AND  E172IMA.FILNFV = E140NFV.CODFIL AND  E172IMA.CODSNF = E140NFV.CODSNF AND  E172IMA.NUMNFV = E140NFV.NUMNFV 
      WHERE E140NFV.CODEMP = 1 AND E020SNF.CODEMP = E140NFV.CODEMP AND E020SNF.CODFIL = E140NFV.CODFIL AND E020SNF.CODSNF = E140NFV.CODSNF AND 0=0 
        AND E140NFV.CODCLI = E085CLI.CODCLI AND E140NFV.CODREP = E090HRP.CODREP AND E090HRP.CODEMP = 1 AND E028CPG.CODEMP = E140NFV.CODEMP AND E028CPG.CODCPG = E140NFV.CODCPG  
        AND E140NFV.DATEMI >= :primeiro AND E140NFV.DATEMI <= :ultimo AND E143NFV.CODEMP = E140NFV.CODEMP AND E143NFV.FILNFV = E140NFV.CODFIL  
        AND E143NFV.CODSNF = E140NFV.CODSNF  AND E143NFV.NUMNFV = E140NFV.NUMNFV  AND E140NFV.TNSPRO NOT IN ('1918') 
      ORDER BY E140NFV.DATEMI
    ";
    $stmt = $this->senior->prepare($sql);
    // echo "<pre>";
    // var_dump($stmt, $primeiroDia, $ultimoDia);
    // die();
    $stmt->execute([':primeiro' => $primeiroDia, ':ultimo' => $ultimoDia]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
  }

  private function ConsultaLoteContabil(string $primeiroDia, string $ultimoDia): array
  {
    $sql = "SELECT E640LOT.CODEMP, E640LOT.NUMLOT, E640LOT.TIPLCT, E640LOT.ORILCT, E640LOT.CODFIL, E640LOT.DATLOT, E640LOT.DATFIX, E640LOT.DESLOT, E640LOT.TOTDEB, 
        E640LOT.TOTCRE, E640LOT.TOTINF, E640LOT.TOTLCT, E640LOT.USULOT, E640LOT.CODUSU, E640LOT.DATENT, E640LOT.HORENT, E640LOT.SITLOT, E640LOT.LOTSIN,
        (SELECT SUM(E640LCT.VLRLCT) FROM E640LCT WHERE E640LCT.CTADEB <> 0 AND E640LCT.SITLCT IN (1,2) AND E640LOT.CODEMP = E640LCT.CODEMP AND E640LOT.NUMLOT = E640LCT.NUMLOT) TOTDEBLCT, 
        (SELECT SUM(E640LCT.VLRLCT) FROM E640LCT WHERE E640LCT.CTACRE <> 0 AND E640LCT.SITLCT IN (1,2) AND E640LOT.CODEMP = E640LCT.CODEMP AND E640LOT.NUMLOT = E640LCT.NUMLOT ) TOTCRELCT 
      FROM E640LOT 
      WHERE E640LOT.CODEMP = 1 AND E640LOT.DATLOT >= :primeiro  AND E640LOT.DATLOT <= :ultimo AND E640LOT.SITLOT = 2  AND 0=0  AND E640LOT.ORILCT = 'VEN' 
      ORDER BY E640LOT.DATLOT
    ";

    $stmt = $this->senior->prepare($sql);
    // echo "<pre>";
    // var_dump($stmt, $numNF);
    // die();
    $stmt->execute([':primeiro' => $primeiroDia, ':ultimo' => $ultimoDia]);
    return $stmt->fetchAll(\PDO::FETCH_ASSOC);
  }
}